<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vireca Test UI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .wallets { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .wallet { padding: 20px; border: 2px solid #ddd; border-radius: 10px; background: #f9f9f9; }
        .wallet.active { border-color: #28a745; background: #f8fff9; }
        .wallet h3 { margin-top: 0; }
        .address { font-family: monospace; font-size: 0.8em; color: #666; word-break: break-all; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .log-content { background: #34495e; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .status { padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .document-item { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #dee2e6; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Vireca Healthcare Data Test UI</h1>
            <p>Backend Status: <span id="backend-status" class="status disconnected">Checking...</span></p>
        </div>

        <div class="wallets">
            <!-- Patient Wallet -->
            <div class="wallet" id="patient-wallet">
                <h3>üë§ Patient Wallet</h3>
                <div class="address">GA5HNMXP4XZL634C3DXKU6AM5WAJ6OKMOIKZ2R3SN22WZXRKCS2XA4MZ</div>
                <button class="btn btn-primary" onclick="connectWallet('patient')">Connect as Patient</button>
                
                <div id="patient-actions" class="hidden">
                    <div class="form-group">
                        <label>Upload Medical Document:</label>
                        <input type="file" id="patient-file" accept=".pdf,.jpg,.jpeg,.png,.txt">
                    </div>
                    <div class="form-group">
                        <label>Document Title:</label>
                        <input type="text" id="patient-title" placeholder="e.g., Blood Test Result">
                    </div>
                    <div class="form-group">
                        <label>Document Type:</label>
                        <select id="patient-type">
                            <option value="medical_report">Medical Report</option>
                            <option value="lab_result">Lab Result</option>
                            <option value="prescription">Prescription</option>
                            <option value="x_ray">X-Ray</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="uploadDocument()">Upload to IPFS</button>
                    
                    <hr>
                    <h4>Grant Access to Doctor</h4>
                    <div class="form-group">
                        <label>IPFS Hash:</label>
                        <input type="text" id="grant-hash" placeholder="Upload document first">
                    </div>
                    <div class="form-group">
                        <label>Duration (hours):</label>
                        <select id="grant-duration">
                            <option value="1">1 hour</option>
                            <option value="24">24 hours</option>
                            <option value="168">1 week</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="grantAccess()">Grant Access</button>
                    
                    <div id="patient-documents"></div>
                </div>
            </div>

            <!-- Doctor Wallet -->
            <div class="wallet" id="doctor-wallet">
                <h3>üë®‚Äç‚öïÔ∏è Doctor Wallet</h3>
                <div class="address">GDOCTOREXAMPLEADDRESS1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ</div>
                <button class="btn btn-primary" onclick="connectWallet('doctor')">Connect as Doctor</button>
                
                <div id="doctor-actions" class="hidden">
                    <div class="form-group">
                        <label>Access Patient Document:</label>
                        <input type="text" id="view-hash" placeholder="Enter IPFS hash">
                    </div>
                    <button class="btn btn-success" onclick="viewDocument()">View Document</button>
                    
                    <div id="doctor-documents"></div>
                    <div id="document-viewer" class="hidden">
                        <h4>Document Viewer</h4>
                        <div id="document-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="log">
            <h3>Activity Log</h3>
            <div class="log-content" id="log-content">Vireca Test UI initialized...\n</div>
            <button class="btn btn-danger" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentWallet = null;
        let currentToken = null;
        let uploadedDocs = [];
        
        const WALLETS = {
            patient: 'GA5HNMXP4XZL634C3DXKU6AM5WAJ6OKMOIKZ2R3SN22WZXRKCS2XA4MZ',
            doctor: 'GDOCTOREXAMPLEADDRESS1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkBackend();
            setInterval(checkBackend, 10000);
        });

        async function checkBackend() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const statusEl = document.getElementById('backend-status');
                if (response.ok) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'status connected';
                    log('‚úÖ Backend connected');
                } else {
                    throw new Error('Backend not healthy');
                }
            } catch (error) {
                const statusEl = document.getElementById('backend-status');
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
                log(`‚ùå Backend error: ${error.message}`);
            }
        }

        function log(message) {
            const logEl = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-content').textContent = 'Log cleared.\n';
        }

        function connectWallet(type) {
            currentWallet = type;
            currentToken = `mock_token_${type}_${Date.now()}`;
            
            // Update UI
            document.querySelectorAll('.wallet').forEach(w => w.classList.remove('active'));
            document.getElementById(`${type}-wallet`).classList.add('active');
            
            document.querySelectorAll('[id$="-actions"]').forEach(a => a.classList.add('hidden'));
            document.getElementById(`${type}-actions`).classList.remove('hidden');
            
            log(`üîó Connected as ${type.toUpperCase()}: ${WALLETS[type]}`);
        }

        async function uploadDocument() {
            if (currentWallet !== 'patient') {
                log('‚ùå Please connect as patient first');
                return;
            }

            const fileInput = document.getElementById('patient-file');
            const title = document.getElementById('patient-title').value;
            const type = document.getElementById('patient-type').value;

            if (!fileInput.files[0] || !title) {
                log('‚ùå Please select file and enter title');
                return;
            }

            const file = fileInput.files[0];
            log(`üì§ Uploading: ${file.name} (${(file.size/1024).toFixed(2)} KB)`);
            log(`üîê Generating crypto signature...`);

            try {
                // Mock signature for 'Vireca_key_v1' - In real app, this would come from wallet
                const mockSignature = `mock_patient_signature_${WALLETS.patient}_vireca_key_v1`;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('owner_public_key', WALLETS.patient);
                formData.append('patient_signature', mockSignature);
                formData.append('metadata', JSON.stringify({
                    title: title,
                    data_type: type,
                    filename: file.name,
                    uploaded_at: new Date().toISOString()
                }));

                const response = await fetch(`${API_BASE}/prepare/register-data`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Document uploaded & encrypted! IPFS: ${result.ipfs_hash}`);
                    log(`üîê Encryption: ${result.metadata.encryption_method}`);
                    
                    const doc = {
                        ipfs_hash: result.ipfs_hash,
                        title: title,
                        type: type,
                        filename: file.name,
                        encrypted: result.metadata.encrypted,
                        signature: mockSignature
                    };
                    uploadedDocs.push(doc);
                    
                    document.getElementById('grant-hash').value = result.ipfs_hash;
                    updateDocumentsList();
                    
                    // Clear form
                    fileInput.value = '';
                    document.getElementById('patient-title').value = '';
                } else {
                    const error = await response.json();
                    log(`‚ùå Upload failed: ${error.detail}`);
                }
            } catch (error) {
                log(`‚ùå Upload error: ${error.message}`);
            }
        }

        async function grantAccess() {
            if (currentWallet !== 'patient') {
                log('‚ùå Please connect as patient first');
                return;
            }

            const hash = document.getElementById('grant-hash').value;
            const duration = parseInt(document.getElementById('grant-duration').value);

            if (!hash) {
                log('‚ùå Please enter IPFS hash');
                return;
            }

            // Find uploaded document for signature
            const doc = uploadedDocs.find(d => d.ipfs_hash === hash);
            if (!doc) {
                log('‚ùå Document not found - upload first');
                return;
            }

            log(`üîê Re-encrypting data key for doctor...`);
            log(`üîê Granting access for ${duration} hours...`);

            try {
                // Mock encrypted data key from blockchain (in real app, this would be fetched)
                const mockEncryptedDataKey = btoa(`patient_encrypted_data_key_${hash}_${Date.now()}`);

                const formData = new FormData();
                formData.append('granter_public_key', WALLETS.patient);
                formData.append('doctor_public_key', WALLETS.doctor);
                formData.append('ipfs_hash', hash);
                formData.append('patient_signature', doc.signature);
                formData.append('patient_encrypted_data_key', mockEncryptedDataKey);
                formData.append('duration_in_ledgers', duration * 720); // ~720 ledgers per hour
                formData.append('access_reason', 'Medical consultation');

                const response = await fetch(`${API_BASE}/prepare/grant-access`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Access granted successfully!`);
                    log(`üîê ${result.crypto_status}`);
                    
                    // Store doctor's encrypted key for viewing
                    const grantedAccess = {
                        ipfs_hash: hash,
                        encrypted_data_key_for_doctor: result.encrypted_data_key_for_doctor,
                        granted_at: new Date().toISOString()
                    };
                    
                    // Store in global variable for doctor access
                    window.doctorAccess = grantedAccess;
                    
                    document.getElementById('view-hash').value = hash;
                } else {
                    const error = await response.json();
                    log(`‚ùå Grant failed: ${error.detail}`);
                }
            } catch (error) {
                log(`‚ùå Grant error: ${error.message}`);
            }
        }

        async function viewDocument() {
            if (currentWallet !== 'doctor') {
                log('‚ùå Please connect as doctor first');
                return;
            }

            const hash = document.getElementById('view-hash').value;
            if (!hash) {
                log('‚ùå Please enter IPFS hash');
                return;
            }

            if (!window.doctorAccess || window.doctorAccess.ipfs_hash !== hash) {
                log('‚ùå No access permission found for this document');
                return;
            }

            log(`üëÄ Doctor decrypting document: ${hash}`);
            log(`üîê Using doctor's encrypted data key...`);

            try {
                const formData = new FormData();
                formData.append('doctor_public_key', WALLETS.doctor);
                formData.append('ipfs_hash', hash);
                formData.append('encrypted_data_key_for_doctor', window.doctorAccess.encrypted_data_key_for_doctor);

                const response = await fetch(`${API_BASE}/doctor/decrypt-data`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Document decrypted successfully!`);
                    log(`üîê ${result.crypto_status}`);
                    
                    // Decode base64 decrypted data
                    const decryptedData = atob(result.decrypted_data);
                    
                    const viewer = document.getElementById('document-viewer');
                    const content = document.getElementById('document-content');
                    
                    content.innerHTML = `
                        <div class="document-item">
                            <h5>üìÑ Decrypted Medical Document</h5>
                            <p><strong>IPFS Hash:</strong> ${hash}</p>
                            <p><strong>Access Time:</strong> ${result.access_time}</p>
                            <p><strong>Data Size:</strong> ${result.data_size} bytes</p>
                            <p><strong>Encryption Status:</strong> ‚úÖ Successfully decrypted</p>
                            <hr>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                                <h6>üìã Medical Content:</h6>
                                <pre style="white-space: pre-wrap; font-family: monospace;">${decryptedData}</pre>
                            </div>
                        </div>
                    `;
                    
                    viewer.classList.remove('hidden');
                } else {
                    const error = await response.json();
                    log(`‚ùå Decryption failed: ${error.detail}`);
                }
            } catch (error) {
                log(`‚ùå View error: ${error.message}`);
            }
        }

        function updateDocumentsList() {
            const patientDocs = document.getElementById('patient-documents');
            
            if (uploadedDocs.length === 0) {
                patientDocs.innerHTML = '<div class="document-item"><em>No documents uploaded yet</em></div>';
                return;
            }

            patientDocs.innerHTML = `
                <h4>üìã My Documents</h4>
                ${uploadedDocs.map(doc => `
                    <div class="document-item">
                        <strong>${doc.title}</strong> (${doc.type})
                        <br><small>File: ${doc.filename}</small>
                        <br><small>IPFS: ${doc.ipfs_hash}</small>
                        <br><a href="https://gateway.pinata.cloud/ipfs/${doc.ipfs_hash}" target="_blank">üîó View on IPFS</a>
                    </div>
                `).join('')}
            `;
        }

        // Initialize
        updateDocumentsList();
    </script>
</body>
</html> 